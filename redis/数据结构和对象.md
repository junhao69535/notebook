# 数据结构和对象

## 简单动态字符串
除了用来保存数据库中的字符串对象之外，SDS还被用作缓冲区：AOF模块中AOF缓冲区，以及客户端状态中的输入缓冲区。

### SDS定义

```c
struct sdshdr {
    // 记录buf数组中已使用字节的数量
    // 等于SDS所保存字符串的长度，不计算空字符'\0'
    int len;

    // 记录buf数组中未使用字节的数量
    int free;

    // 字节数组，用于保存字符串
    char buf[];
};
```

### SDS与C字符串的区别
#### 常数复杂度获取字符串长度
和C字符串不同，因为SDS在len属性中记录了SDS本身的长度，所以获取一个SDS长度的复杂度仅为O(1)。

#### 杜绝缓冲区溢出
当SDS的API需要对SDS进行修改时，API会先检查SDS的空间是否满足所需的要求，如果不满足的话，API会自动将SDS的空间扩展至执行修改所需的大小，API会自动将SDS的空间扩展至执行修改所需的大小，然后才执行实际的修改操作，所以使用SDS既不需要手动修改SDS的空间大小，也不会出现前面所说的缓冲区溢出问题。

#### 减少修改字符串时带来的内存重分配次数
通过未使用空间（sds结构体中的free变量指定），SDS实现了空间预分配和惰性空间释放两种优化策略。

1. 空间预分配
额外分配的未使用空间数量由以下公式决定：

* 如果对SDS进行修改后，SDS的长度（也即是len属性的值）将小于1MB，那么程序分配和len属性同样大小的未使用空间，这时SDSlen属性的值将和free属性的值相同。
* 如果对SDS进行修改之后，SDS的长度将大于等于1MB，那么程序会分配1MB的未使用空间。

通过空间预分配策略，Redis可以减少连续执行字符串增长操作所需的内存重分配次数。连续增长N次字符串所需的内存重分配次数从必定N次降低未最多N次。

2. 惰性空间释放
惰性空间释放用于释放SDS的字符串缩短操作：当SDS的API需要缩短SDS保存的字符串时，程序并不立即使用内存重分配来回收缩短后多出来的字节，而是使用free属性将这些字节的数量记录起来，并等待将来使用。

与此同时，SDS也提供了相应的API，让我们可以在有需要时，真正地释放SDS的未使用空间，所以不用担心惰性空间释放策略会造成内存浪费。

#### 二进制安全
程序不会对SDS中的数据做任何限制、过滤、或者假设，数据在写入时是什么样的，它被读取时就是什么样。SDS中的buf不是用来保存字符的，而是保存一系列的二进制数据。例如，使用SDS来保存特殊数据格式没有任何问题，因为SDS使用len属性的值而不是空字符来判断字符串是否结束。

通过使用二进制安全的SDS，而不是C字符串，使得Redis不仅可以保存文本数据，还可以保存任意格式的二进制数据。

#### 兼容部分C字符串函数
通过遵循C字符串以空字符结尾的惯例，SDS可以在**有需要时**重用<string.h>函数库，从而避免了不必要的代码重复。

#### 总结
下表对C字符串和SDS之间的区别进行了总结。

|                 C字符串                 |                  SDS                   |
| -------------------------------------- | -------------------------------------- |
| 获取字符串长度的复杂度为O(N)              | 获取字符串长度的复杂度为O(1)              |
| API是不安全的，可以会造成缓冲区溢出       | API是安全的，不会造成缓冲区溢出           |
| 修改字符串长度N次必须需要执行N次内存重分配 | 修改字符串长度N次最多需要执行N次内存重分配 |
| 只能保存文本数据                         | 可以保存文本或者二进制数据                |
| 可以使用所有<string.h>库中的函数         | 可以使用一部分<string.h>库中的函数        |

### 重点
1. Redis使用SDS作为字符串表示。
2. 比起C字符串，SDS具有以下优点：

* 常数复杂度获取字符串长度。
* 杜绝缓冲区溢出。
* 减少修改字符串长度时所需的内存重分配次数。
* 二进制安全。
* 兼容部分C字符串函数。


## 链表
当一个列表键包含了数量比较多的元素，又或者列表中包含的元素都是比较长的字符串时，Redis就会使用**链表**作为列表键的底层实现。

相反，当元素较少或元素都是较短的字符串时，**压缩列表**作为列表键的底层实现。

除了列表键之外，发布与订阅、慢查询、监视器等功能也用到了链表，Redis服务器本身还使用链表来保存多个客户端的状态信息，以及使用链表来构建客户端输出缓冲区。

### 
