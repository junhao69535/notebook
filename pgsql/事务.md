# 事务

## 事务概念
构成单一逻辑工作单元的操作集合称作**事务**。

这些步骤集合必须作为一个单一的、不可分割的单元出现。要么执行其全部内容，要么都不执行。这种特性称为**原子性**。

数据库必须采取特殊处理确保事务正常执行二不被来自并发执行的数据库语句干扰。这种特性称为**隔离性**。

即使系统奔溃后事务的操作也必须是持久的。这种特性称为**持久性**。

上面三个特性实际上是完成**一致性**。一致性的期望很多，如何实现依赖于应用层。

**确保隔离性有可能对系统性能造成较大的不利影响。因此，一些应用在隔离性上采取一些妥协。**


## 事务隔离性
当多个事务并发地执行时，可能违背隔离性，这导致即使每个事务都正确执行，数据库的一致性也可能被破坏。

数据库系统必须控制事务之间的交互，以防止它们破坏数据库的一致性。系统通过称为**并发控制机制**的一系列机制来保证这一点。


## 事务隔离性级别
SQL标准规定的隔离性级别如下：

* 可串行化：保证可串行化调度。
* 可重复读：只允许读取已提交的数据，而且一个事务两次读取一个数据项期间，其他事务不得更新该数据。
* 已提交读：只允许读取已提交数据，但不要求可重复读。
* 未提交读：允许读取未提交数据。这是SQL允许的最低一致性级别。

以上所有隔离性级别都不允许脏写，即如果一个数据项已经被另外一个尚未提交或终止的事务写入，则不允许对该数据项执行写操作。

一个应用程序可能为了提交系统性能而接受较弱的隔离性级别。虽然为了性能可能会带来短暂的数据库不一致风险，但是如果确保这种不一致性是和应用程序无关的，则这种权衡是合理的。


## 隔离性级别的实现
### 锁
如共享锁、排他锁。

### 时间戳
为每个事务分配一个时间戳，通常是当事务开始的时候。对于每个数据项，系统维护两个时间戳。数据项的读时间戳记录读该数据项的事务的最大时间戳。数据项写时间戳记录写入该数据项当前值的事务的时间戳。时间戳用来确保在访问冲突情况下，事务按照事务时间戳的顺序访问数据量。当不可能访问时，违例事务将会中止，并且分配一个新的时间戳重新开始。

### 多版本和快照隔离
通过维护数据项的多个版本，一个事务允许读取一个旧版本的数据项，而不是被另一个未提交或者在串行化序列中应该排在后面的事务写入的新版本的数据量。有许多多版本控制并发技术，其中一种实现是**快照隔离**。

在快照隔离中，每个事务开始时有其自身的数据库版本或者快照。从这个私有版本中读取数据，因此和其他事务所作的更新隔离开。如果事务更新数据库，更新只出现在其私有版本中，而不是实际的数据库本身中。当事务提交时，和更新有关的信息将保存，使得更新被写入”真正的“数据库。

快照隔离可以保证读数据的尝试永远无须等待（不像封锁的情况）。由于每个事务读取它自己的数据库版本或快照，因此读数据不会导致此候其他事务的更新尝试被迫等待。在读多写少情况，比锁更能改善性能。


